<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ë¸”ë ˆìŠ¤ ë°ì´í„° í˜„í™© (í†µí•©ë³¸)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* Base Styling */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            color: #ddd;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            user-select: none;
        }
        
        /* Logo Code for Upper Right Diagonal Placement */
        .fixed-logo-container {
            position: fixed;
            top: 40px;
            right: 340px;
            z-index: 95;
            pointer-events: none;
        }

        .wrap {
            flex-grow: 1;
            /* left-menu (180px) + margin (20px) = 200px */
            padding: 20px 20px 20px 200px;
            position: relative; /* selectionBox ê¸°ì¤€ì  */
            max-width: calc(100vw - 320px);
            overflow: auto; /* ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ */
            user-select: auto;
            /* .wrap ë‚´ë¶€ì—ì„œëŠ” í…ìŠ¤íŠ¸ ì„ íƒ ê°€ëŠ¥ */
        }

        /* Setting Panel Styling */
        .setting-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background-color: #2c2c2c;
            padding: 15px;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            z-index: 100;
            user-select: auto;
        }

        .setting-panel h3 {
            font-size: 1.1em;
            color: #ffdd66;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .color-target-control label {
            margin-right: 15px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 5px 0;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #333;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border: 1px solid #555;
            cursor: pointer;
            border-radius: 3px;
            transition: transform 0.1s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #ffdd66;
        }

        .download-button {
            width: 100%;
            margin-top: 20px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .download-button:hover {
            background-color: #45a049;
        }

        .small-btn { padding:6px 8px;
            background:#444;color:#fff;border-radius:4px;border:none;cursor:pointer }
        .small-btn:hover{background:#555}
        .small-btn:disabled{background:#222; cursor:not-allowed;
            color:#888;}

        /* Menu Styling */
        .top-sub-menu {
            display: flex;
            margin-bottom: 12px;
            border-bottom: 2px solid #555;
            padding-bottom: 8px;
        }

        .menu {
            margin-right: 20px;
            font-size: 0.9em;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .menu:hover {
            color: #fff;
        }
        .menu.active { color: #fff; font-weight: 600; border-bottom: 2px solid #ffdd66; padding-bottom: 6px;
        }

        /* Left menu */
        .left-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 180px;
            height: 100vh;
            background-color: #222;
            padding: 20px 0;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .left-item {
            padding: 10px 16px;
            font-size: 0.95em;
            color: #bbb;
            cursor: pointer;
            transition: background-color 0.12s, color: 0.12s;
            border-left: 6px solid transparent;
            margin-bottom: 4px;
            border-radius: 0 6px 6px 0;
        }

        .left-item:hover {
            background: rgba(255,221,102,0.03);
            color: #fff;
        }

        .left-item.active {
            background: linear-gradient(90deg, rgba(255,221,102,0.06), rgba(255,221,102,0.02));
            border-left-color: #ffdd66;
            color: #fff;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        /* menu indicator */
        .menu-indicator {
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(255,221,102,0.06);
            color: #ffdd66;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            table-layout: fixed;
            user-select: auto;
        }

        .data-table td {
            border: 1px solid #444;
            padding: 5px 8px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            height: 15px;
            box-sizing: border-box;
            transition: background-color 0.1s, border-color 0.1s;
        }

        /* Row Group Styles */
        .top-notice-row td {
            background-color: #581616;
            color: #ffe6e6;
            font-weight: bold;
            text-align: left;
            padding: 8px 12px;
            height: 35px;
        }
        .top-notice-mark {
            color: #ffdd66;
            margin-right: 8px;
        }

        .top-data-header td, .bottom-data-header td {
            background-color: #444;
            color: #fff;
            font-weight: bold;
            height: 30px;
            min-width: 80px;
        }

        .middle-notice-row td {
            background-color: #3a3a3a;
            color: #ffb3b3;
            text-align: left;
            font-size: 0.9em;
            line-height: 1.4;
            height: 50px;
        }

        .bottom-data-row td {
            background-color: #333;
            color: #ddd;
        }

        /* Editable Content Styling - Ensure text selection works */
        .data-table td[contenteditable="true"] {
            user-select: text !important;
            cursor: text;
            outline: none;
        }
        .data-table td[contenteditable="false"] {
            cursor: not-allowed;
            user-select: none;
        }

        /* ğŸš€ [FINAL FIX] ë“œë˜ê·¸ ì¤‘ ë¸Œë¼ìš°ì € í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
        .disable-select * {
            user-select: none !important;
            -webkit-user-select: none !important;
        }

        /* Selection Box (for drag visual) */
        #selectionBox {
            position: absolute;
            /* .wrap ê¸°ì¤€ ìœ„ì¹˜ */
            border: 2px dashed #FFD700;
            background-color: rgba(255, 215, 0, 0.2);
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        /* Selected Cell Styling (Actual selection state) */
        .data-table td.selected {
            border: 2px solid #ffdd66 !important;
            box-shadow: inset 0 0 0 1px #ffdd66, 0 0 5px rgba(255, 221, 102, 0.5);
            position: relative;
            z-index: 5;
        }

        /* small responsive fix */
        @media (max-width: 900px) {
            .wrap { padding-left: 20px;
            }
            .left-menu { display: none;
            }
        }
    </style>
</head>
<body>

<div class="fixed-logo-container">
    <img src="unnamed (8).png" alt="Logo" style="width: 100px; height: auto;">
</div>


<div class="setting-panel" id="settingPanel">
    <div style="color: #ffdd66; margin-top: 5px; margin-bottom: 10px; font-weight: bold;">
        â€» ì‚¬ìš©ë²•:
        <br>1.
        **ê¸€ì í¸ì§‘**: ì…€ **ì¼ë°˜ í´ë¦­** í›„ ë°”ë¡œ ìˆ˜ì •.
        <br>2. **ìŠ¤íƒ€ì¼ ì ìš©**: <span style="color:#00ffff;">`Ctrl` ë˜ëŠ” `Cmd` í‚¤</span>ë¥¼ ëˆ„ë¥¸ ì±„ **ë“œë˜ê·¸**í•˜ì—¬ ì…€ ì„ íƒ í›„ ì ìš©.
    </div>

    <div class="color-target-control">
        <label><input type="radio" name="colorTarget" value="text" checked> ê¸€ììƒ‰ ì ìš©</label>
        <label><input type="radio" name="colorTarget" value="background"> ë°°ê²½ìƒ‰ ì ìš©</label>
    </div>

    <div class="color-control">
        <h3>ğŸ¨ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì„ íƒ (40ìƒ‰)</h3>
        <div class="color-palette" id="colorPaletteContainer"></div>
    </div>

    <div style="margin-top: 10px; padding-top: 15px; border-top: 1px solid #444;">
        <label for="fontSizeInput">ê¸€ê¼´ í¬ê¸° (px): </label>
        <input 
            type="number" id="fontSizeInput" min="8" max="48" value="14" style="width: 60px; margin-left: 5px; padding: 5px; color: black; border-radius: 3px; border: none;">
        <button id="applyFontSizeBtn" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer; transition: background 0.2s;">ì ìš©</button>
    </div>

    <div style="margin-top: 15px; padding-top: 15px;
        border-top: 1px solid #444;">
        <h3>ğŸ“ ê·¸ë£¹ë³„ í–‰ ë†’ì´ (px)</h3>
        
        <div style="margin-bottom: 10px;">
            <label for="topNoticeRowHeightInput" style="display: block;
                margin-bottom: 5px;">ìµœìƒë‹¨ ê³µì§€ í–‰ ë†’ì´:</label>
            <input type="number" id="topNoticeRowHeightInput" min="20" max="300" value="35" style="width: 60px;
                padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyTopNoticeRowHeightBtn" class="height-apply-btn" data-target="top-notice" style="margin-left: 5px;
                padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px;
                cursor: pointer;">ì ìš©</button>
        </div>
        
        <div style="margin-bottom: 10px;">
           
            <label for="topRowHeightInput" style="display: block;
                margin-bottom: 5px;">ìƒë‹¨ ë°ì´í„° í–‰ ë†’ì´:</label>
            <input type="number" id="topRowHeightInput" min="10" max="200" value="25" style="width: 60px;
                padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyTopRowHeightBtn" class="height-apply-btn" data-target="top-data" style="margin-left: 5px;
                padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px;
                cursor: pointer;">ì ìš©</button>
        </div>

        <div style="margin-bottom: 10px;">
            <label for="middleNoticeRowHeightInput" style="display: block;
                margin-bottom: 5px;">ì¤‘ë‹¨ ê³µì§€/ì œëª© í–‰ ë†’ì´:</label>
            <input type="number" id="middleNoticeRowHeightInput" min="20" max="300" value="50" style="width: 60px;
                padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyMiddleNoticeRowHeightBtn" class="height-apply-btn" data-target="middle-notice" style="margin-left: 5px;
                padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px;
                cursor: pointer;">ì ìš©</button>
        </div>

        <div>
            <label for="bottomRowHeightInput" style="display: block;
                margin-bottom: 5px;">í•˜ë‹¨ ë°ì´í„° í–‰ ë†’ì´:</label>
            <input type="number" id="bottomRowHeightInput" min="10" max="200" value="25" style="width: 60px;
                padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyBottomRowHeightBtn" class="height-apply-btn" data-target="bottom-data" style="margin-left: 5px;
                padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px;
                cursor: pointer;">ì ìš©</button>
        </div>
        <button id="autoFitBtn" class="small-btn" style="margin-top: 10px;
            width: 100%; background: #007bff;">ì—´ ë„ˆë¹„ ìë™ ë§ì¶¤ (Auto-Fit)</button>
    </div>
    
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
        <h3>âœï¸ ë¬¸êµ¬ í¸ì§‘ (Custom Text)</h3>
        <label for="editTopText" style="display: block; margin-bottom: 5px; font-size: 0.9em; color:#fff;">ìƒë‹¨ ë¬¸êµ¬ (í•œ ì¤„):</label>
        <input type="text" id="editTopText" value="ë‹¹ì‹ ì˜ ì·¨í–¥ì„ ê³µìœ í•˜ë©°, ëœ¨ê±°ìš´ êµê°ì„ ë‚˜ëˆŒ ì€ë°€í•œ íŒŒíŠ¸ë„ˆ. ì€ë°€í•œ ë§Œë‚¨ì„ í†µí•´ ìµœìƒì˜ ë§Œì¡±ê°ì„ ê²½í—˜í•˜ì„¸ìš”." 
            style="width: 100%; padding: 5px; color: black; border-radius: 3px; border: none; margin-bottom: 10px;">

        <label for="editBottomText" style="display: block; margin-bottom: 5px; font-size: 0.9em; color:#fff;">í•˜ë‹¨ ê³µì§€ (HTML/ì¤„ë°”ê¿ˆ ê°€ëŠ¥):</label>
        <textarea id="editBottomText" rows="4" style="width: 100%; padding: 5px; color: black; border-radius: 3px; border: none; resize: vertical;">[ì¤‘ìš” ê³µì§€] ì—…ë¬´ ì§„í–‰ ì¤‘ í•µì‹¬ ì •ë³´ë¥¼ ëˆ„ë½í•˜ëŠ” ì¼ì´ ì—†ë„ë¡ ë‹´ë‹¹ìì˜ ì§€ì‹œì— ë”°ë¼ ì‹ ì¤‘í•˜ê²Œ ì²˜ë¦¬í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.<br>ê°œë³„ ì—…ë¬´ ì²˜ë¦¬ë¡œ ë°œìƒí•˜ëŠ” ëª¨ë“  ê²°ê³¼ ì±…ì„ì€ ë‹¹ì‚¬ìì—ê²Œ ê·€ì†ë©ë‹ˆë‹¤. ì§„í–‰ ìƒí™©ì€ ì‹œìŠ¤í…œì— ì‹¤ì‹œê°„ ë°˜ì˜ë˜ì˜¤ë‹ˆ, í•­ìƒ í™•ì¸í•˜ì—¬ ì£¼ì‹­ì‹œì˜¤.</textarea>

        <button id="applyTextChangesBtn" class="small-btn" style="width: 100%; background: #ff7700;">ë¬¸êµ¬ ì ìš© ë° ì €ì¥</button>
    </div>


    <div style="margin-top: 15px; padding-top: 15px;
        border-top: 1px solid #444;">
        <h3>âš™ï¸ ì‘ì—… ë„êµ¬</h3>
        <div style="display:flex;
            gap:8px; margin-bottom:8px;">
            <button id="autoSaveToggleBtn" class="small-btn">ìë™ì €ì¥: OFF</button>
            <button id="saveNowBtn" class="small-btn">ì €ì¥</button>
            <button id="copyBtn" class="small-btn">ë³µì‚¬</button>
            <button id="pasteBtn" class="small-btn">ë¶™ì—¬ë„£ê¸°</button>
        </div>
        <div style="display:flex;
            gap:8px; margin-bottom:8px;">
            <button id="addRowBtn" class="small-btn">í–‰ ì¶”ê°€</button>
            <button id="addColBtn" class="small-btn">ì—´ ì¶”ê°€</button>
            <button id="deleteRowBtn" class="small-btn">í–‰ ì‚­ì œ</button>
            <button id="deleteColBtn" class="small-btn">ì—´ ì‚­ì œ</button>
        </div>
        <div style="display:flex;
            gap:8px;">
            <button id="toggleAdminBtn" class="small-btn" style="background: #4CAF50;">ê´€ë¦¬ì ëª¨ë“œ: ON</button>
            <button id="downloadBtn" class="small-btn" style="background: #4CAF50;">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <button class="download-button" id="downloadFullBtn" style="margin-top:12px;">ğŸ–¼ï¸ ì „ì²´ ì˜ì—­ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (PNG)</button> 
</div>

<div class="left-menu" id="leftMenu">
    <div class="left-item active">ë©”ì¸ í™”ë©´</div>
    <div class="left-item">[ë§¤ì¹­/ê³ ê° ìƒíƒœ]</div>
    <div class="left-item">ì£¼ë¬¸ ìƒíƒœ</div>
    <div class="left-item">ì¸ì¦ ìƒíƒœ</div>
    <div class="left-item">[ìƒë‹´/ë¬¸ì˜]</div>
    <div class="left-item">ì§ë¬´ ë¬¸ì˜</div>
  
    <div class="left-item">ì „êµ­ ë§Œë‚¨</div>
    <div class="left-item">[ê´€ë¦¬/ë°ì´í„°]</div>
    <div class="left-item">ì‹¤ì‹œê°„ ë°ì´í„°</div>
    <div class="left-item">ì‹¤ì‹œê°„ ì˜¤ë¥˜</div>
    <div class="left-item">ë°ì´í„° ë¶„ì„</div>
    <div class="left-item">í¬ì¸íŠ¸ ì¡°íšŒ</div>
    <div class="left-item">ìœ í¥ ê´€ë¦¬</div>
    <div class="left-item">íšŒì› ê´€ë¦¬</div>
    <div class="left-item">íšŒì› ìŠ¹ì¸</div>
    <div class="left-item">íšŒì› íƒˆí‡´</div>
    <div class="left-item">ë‹´ë‹¹ ì‹¤ì¥</div>
</div>

<div class="wrap">
    <div id="selectionBox"></div>

    <div id="topNoticeContainer" style="text-align: center; color: #ffdd66; font-size: 1.1em; margin-bottom: 20px; font-weight: bold; line-height: 1.5;">
        <span id="topNoticeText">ë‹¹ì‹ ì˜ ì·¨í–¥ì„ ê³µìœ í•˜ë©°, ëœ¨ê±°ìš´ êµê°ì„ ë‚˜ëˆŒ ì€ë°€í•œ íŒŒíŠ¸ë„ˆ. ì€ë°€í•œ ë§Œë‚¨ì„ í†µí•´ ìµœìƒì˜ ë§Œì¡±ê°ì„ ê²½í—˜í•˜ì„¸ìš”.</span>
    </div>

    <div class="top-sub-menu" id="topSubMenu">
        <div class="menu active">ë¸”ë ˆìŠ¤ ì „êµ­ í”„ë ˆìŠ¤í‹°ì§€ ì„œë¹„ìŠ¤</div>
        <div class="menu">VIP íšŒì› ì „ìš© 
            í†µí•© ë§¤ë‹ˆì§€ë¨¼íŠ¸</div>
        <div class="menu">ë…¸ë¸”ë ˆìŠ¤ íšŒì› ì „ìš©ë£¸</div>
    </div>
    
    <div id="menuIndicator" class="menu-indicator">ì„ íƒ: ë©”ì¸ í™”ë©´</div>

    <table class="data-table" id="capture-area">
        <tbody>
            <tr class="top-notice-row">
                <td colspan="5" contenteditable="true"> <span class="top-notice-mark">DAMAGE!</span> ì£¼ì˜ì‚¬í•­ 4ë‹¨ê³„ì—ì„œ ì¼ì¹˜ íŒŒíŠ¸ë„ˆì‹­ìœ¼ë¡œ í†µí•©ëœ ìœ í˜•ë§Œì„ ì„ íƒí•˜ì—¬ ê³µìœ  ì„ë¬´ë¥¼ ì™„ë£Œí•˜ë©° í•¨ê»˜ í• ë•Œì˜ ê¸ˆì¼ ê²°ì œ ê¸ˆì•¡ í›„ ê³µë™ ì´ìµì„ ë§ˆê°í•´ì•¼ í•©ë‹ˆë‹¤!
                </td>
            </tr>
            
            <tr class="top-data-header">
                <td contenteditable="true">íšŒì›ID</td>
                <td contenteditable="true">ì£¼ë¬¸ìƒíƒœ</td>
                <td contenteditable="true">ì¸ì¦ìƒíƒœ</td>
                <td contenteditable="true">í™œì„±í™” ì½”ë“œ</td>
                <td contenteditable="true">ìŠ¹ì¸ëœ ì•”í˜¸ ì½”ë“œ</td>
            </tr>
            
            <tr class="top-data-row">
                <td contenteditable="true">jkgov1203</td>
                <td contenteditable="true">ë°œì†¡ ì™„ë£Œ</td>
                <td contenteditable="true">ìŠ¹ì¸ ì™„ë£Œ</td>
                <td contenteditable="true">NSACT2032897</td>
                <td contenteditable="true">NBS001001001</td>
            </tr>
            
            <tr class="top-data-row">
                <td contenteditable="true">sxcv4752</td>
                <td contenteditable="true">ê²€ìˆ˜ ëŒ€ê¸°</td>
                <td contenteditable="true">ë¯¸ìŠ¹ì¸</td>
                <td contenteditable="true">NSACT2032898</td>
                <td contenteditable="true">NBS001001002</td>
            </tr>
    
            <tr class="top-data-row">
                <td contenteditable="true">qwerty24689</td>
                <td contenteditable="true">ì§„í–‰ ì¤‘</td>
                <td contenteditable="true">ìŠ¹ì¸ ì™„ë£Œ</td>
                <td contenteditable="true">NSACT2032899</td>
                <td contenteditable="true">NBS001001003</td>
            </tr>
            
            <tr class="top-data-row">
                <td contenteditable="true">xsgf1575</td>
                <td contenteditable="true">ë°œì†¡ ì˜¤ë¥˜</td>
                <td contenteditable="true">ë¹„í™œì„±í™”</td>
                <td contenteditable="true">NSACT2032891</td>
                <td contenteditable="true">NBS001001004</td>
            </tr>
        </tbody>
    </table>

    <div style="text-align: center; margin-top: 20px; padding: 15px; background-color: #2c2c2c; border-radius: 6px; color: #aaa; font-size: 0.9em; line-height: 1.6;">
        <span style="font-size: 3em; line-height: 0; vertical-align: middle; padding-right: 10px; color:#666;">[</span>
        <span id="bottomNoticeText" style="display: inline-block; max-width: 90%; text-align: center;">
            [ì¤‘ìš” ê³µì§€] ì—…ë¬´ ì§„í–‰ ì¤‘ í•µì‹¬ ì •ë³´ë¥¼ ëˆ„ë½í•˜ëŠ” ì¼ì´ ì—†ë„ë¡ ë‹´ë‹¹ìì˜ ì§€ì‹œì— ë”°ë¼ ì‹ ì¤‘í•˜ê²Œ ì²˜ë¦¬í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.<br>
            ê°œë³„ ì—…ë¬´ ì²˜ë¦¬ë¡œ ë°œìƒí•˜ëŠ” ëª¨ë“  ê²°ê³¼ ì±…ì„ì€ ë‹¹ì‚¬ìì—ê²Œ ê·€ì†ë©ë‹ˆë‹¤. ì§„í–‰ ìƒí™©ì€ ì‹œìŠ¤í…œì— ì‹¤ì‹œê°„ ë°˜ì˜ë˜ì˜¤ë‹ˆ, í•­ìƒ í™•ì¸í•˜ì—¬ ì£¼ì‹­ì‹œì˜¤.
        </span>
        <span style="font-size: 3em; line-height: 0; vertical-align: middle; padding-left: 10px; color:#666;">]</span>
    </div>

</div>


<script type="module">
    
    // DOM refs
    const table = document.querySelector('.data-table');
    const colorPaletteContainer = document.getElementById('colorPaletteContainer');
    const applyFontSizeBtn = document.getElementById('applyFontSizeBtn');
    const fontSizeInput = document.getElementById('fontSizeInput');
    const selectionBox = document.getElementById('selectionBox');
    const leftMenu = document.getElementById('leftMenu');
    const menuIndicator = document.getElementById('menuIndicator');
    const topSubMenu = document.getElementById('topSubMenu');
    const wrap = document.querySelector('.wrap'); // wrap element ì¶”ê°€
    
    // ğŸš€ [NEW] Custom Text DOM refs
    const topNoticeText = document.getElementById('topNoticeText');
    const bottomNoticeText = document.getElementById('bottomNoticeText');
    const editTopText = document.getElementById('editTopText');
    const editBottomText = document.getElementById('editBottomText');
    const applyTextChangesBtn = document.getElementById('applyTextChangesBtn');


    // Tool buttons
    const autoSaveToggleBtn = document.getElementById('autoSaveToggleBtn');
    const saveNowBtn = document.getElementById('saveNowBtn');
    const copyBtn = document.getElementById('copyBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const addRowBtn = document.getElementById('addRowBtn');
    const addColBtn = document.getElementById('addColBtn');
    const deleteRowBtn = document.getElementById('deleteRowBtn');
    const deleteColBtn = document.getElementById('deleteColBtn');
    const autoFitBtn = document.getElementById('autoFitBtn');
    const toggleAdminBtn = document.getElementById('toggleAdminBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadFullBtn = document.getElementById('downloadFullBtn');
    
    // constants
    const COLOR_PALETTE = [
        '#FFFFFF', '#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF',
        '#FFA500', '#800080', '#008000', '#808000', '#000080', '#800000', '#C0C0C0', '#808080',
        '#FF4500', '#ADFF2F', '#1E90FF', '#FFD700', '#20B2AA', '#E9967A', '#9400D3', '#FF69B4',
        '#A0522D', '#D2B48C', '#87CEEB', '#F08080', '#4682B4', '#DA70D6', '#B0C4DE', '#F4A460',
        '#5F9EA0', '#DDA0DD', '#7FFF00', '#6495ED', '#DC143C', '#FF8C00', '#9ACD32', '#40E0D0'
    ];
    // selection
    let isDragging = false;
    let startCell = null;
    let endCell = null;
    let selectedCells = new Set();
    let autoSave = false;
    let autoSaveDebounceMs = 800;
    let saveTimer = null;
    let adminMode = true; // ê¸°ë³¸ê°’ì€ í™œì„±í™”(í¸ì§‘ ê°€ëŠ¥)

    // helpers
    const debounce = (fn, ms) => {
        return (...args) => {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => fn(...args), ms);
        };
    };

    const saveTableStateImmediate = async () => {
        // FIX: ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ê¸°ëŠ¥ ë¹„í™œì„±í™” (ë¡œì»¬ ì‚¬ìš©)
        console.log('[Notice] Data saving logic is disabled (local execution).');
    };
    const saveTableStateDebounced = debounce(saveTableStateImmediate, autoSaveDebounceMs);
    
    // V2: í–‰ ë†’ì´ ì ìš© ë¡œì§ ê°œì„  (height, line-height ë¶„ë¦¬)
    const applyRowHeight = (target, value) => {
        const heightPx = `${value}px`;
        const lineHeight = `${parseInt(value) - 10}px`; // padding/border ê³ ë ¤
        const selectors = {
            'top-notice': '.top-notice-row', 
            'top-data': '.top-data-row, .top-data-header',
            'middle-notice': '.middle-notice-row',
            'bottom-data': '.bottom-data-row, .bottom-data-header'
        };
        if (selectors[target]) {
            table.querySelectorAll(selectors[target]).forEach(row => {
                row.style.height = heightPx;
                row.querySelectorAll('td').forEach(td => {
                    td.style.height = heightPx;
                    // ë†’ì´ê°€ ë„ˆë¬´ ì‘ì„ ë•Œ line-heightë¥¼ 
                    // ì¡°ì ˆí•˜ì§€ ì•ŠìŒ
                    if (parseInt(value) > 15) {
                        td.style.lineHeight = lineHeight; 
                    } else {
                        td.style.lineHeight = 
                            'normal';
                    }
                });
            });
        }
    };

    const isDataRow = (row) => {
        return row.classList.contains('top-data-row') ||
            row.classList.contains('bottom-data-row');
    }

    // --- ê´€ë¦¬ì ëª¨ë“œ í† ê¸€ ë¡œì§ (MODIFIED) ---
    const toggleAdminMode = (forceState = null) => {
        adminMode = forceState !== null ?
            forceState : !adminMode;
        if (toggleAdminBtn) {
            toggleAdminBtn.textContent = `ê´€ë¦¬ì ëª¨ë“œ: ${adminMode ?
                'ON' : 'OFF'}`;
            toggleAdminBtn.style.background = adminMode ? '#4CAF50' : '#a33';
        }

        // ğŸš€ FIX: í—¤ë” í¬í•¨ ëª¨ë“  ì…€ì— contentEditable ìƒíƒœ ì ìš© (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜)
        table.querySelectorAll('tr').forEach(row => {
            row.querySelectorAll('td').forEach(td => {
                // ê´€ë¦¬ì ëª¨ë“œ ìƒíƒœì— ë”°ë¼ ëª¨ë“  ì…€ì˜ í¸ì§‘ ê°€ëŠ¥ ìƒíƒœë¥¼ ì¼ê´„ ì ìš©
                td.contentEditable = adminMode;
            });
        });

        clearSelection();
    };
    const applyLoadedState = () => {
        // ì´ˆê¸° HTMLì´ ë¡œë“œë  ë•Œ ê¸°ë³¸ ë†’ì´ ì ìš©
        applyRowHeight('top-notice', document.getElementById('topNoticeRowHeightInput').value);
        applyRowHeight('top-data', document.getElementById('topRowHeightInput').value);
        // ì‚­ì œëœ í–‰ ê·¸ë£¹ì— ëŒ€í•œ ë†’ì´ ì„¤ì •ì€ ë¬´ì‹œí•˜ê±°ë‚˜, ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        // ì´ ë¡œì§ì€ ê¸°ì¡´ ì½”ë“œë¥¼ ìµœëŒ€í•œ ìœ ì§€í•˜ê¸° ìœ„í•´ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤.
        // applyRowHeight('middle-notice', document.getElementById('middleNoticeRowHeightInput').value);
        // applyRowHeight('bottom-data', document.getElementById('bottomRowHeightInput').value);
        
        // ê´€ë¦¬ì ëª¨ë“œ ìƒíƒœ ì´ˆê¸°í™”
        toggleAdminMode(adminMode); 
        
        // ğŸš€ [NEW] ë¡œë“œ ì‹œ, input/textareaì— í˜„ì¬ í‘œì‹œ ì¤‘ì¸ í…ìŠ¤íŠ¸ ì„¤ì • (ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
        if (editTopText && topNoticeText) {
            editTopText.value = topNoticeText.textContent;
        }
        if (editBottomText && bottomNoticeText) {
            // innerHTMLì—ì„œ <br>ì„ \nìœ¼ë¡œ ë³€í™˜í•˜ì—¬ textareaì— í‘œì‹œ
            editBottomText.value = bottomNoticeText.innerHTML.replace(/<br\s*\/?>/g, '\n').trim();
        }

        clearSelection();
    };

    document.addEventListener('DOMContentLoaded', () => { 
        initializeColorPalette(); 
        applyLoadedState(); 
    });
    const clearSelection = () => {
        selectedCells.forEach(cell => cell.classList.remove('selected'));
        selectedCells.clear();
        selectionBox.style.display = 'none';
        startCell = null;
        endCell = null;
    };

    const getCellCoordinates = (cell) => ({ rowIndex: cell.closest('tr').rowIndex, cellIndex: cell.cellIndex });
    const updateSelection = (startPos, endPos) => {
        const r1 = Math.min(startPos.rowIndex, endPos.rowIndex);
        const r2 = Math.max(startPos.rowIndex, endPos.rowIndex);
        const c1 = Math.min(startPos.cellIndex, endPos.cellIndex);
        const c2 = Math.max(startPos.cellIndex, endPos.cellIndex);

        clearSelection();
        for (let r = r1; r <= r2; r++) {
            const row = table.rows[r];
            if (!row) continue;
            for (let c = c1; c <= c2; c++) {
                const cell = row.cells[c];
                if (cell) {
                    cell.classList.add('selected');
                    selectedCells.add(cell);
                }
            }
        }
    };
    // ë“œë˜ê·¸ ë°•ìŠ¤ ìœ„ì¹˜ ê³„ì‚° ë¡œì§ (ìŠ¤í¬ë¡¤ ë° wrap ê¸°ì¤€ìœ¼ë¡œ ë³´ì •)
    const updateSelectionBoxVisual = (startCell, endCell) => {
        if (!startCell || !endCell) return;
        const wrapRect = wrap.getBoundingClientRect(); // .wrapì˜ ë·°í¬íŠ¸ ìœ„ì¹˜
        const wrapScrollLeft = wrap.scrollLeft;
        const wrapScrollTop = wrap.scrollTop;

        const sRect = startCell.getBoundingClientRect(); // startCellì˜ ë·°í¬íŠ¸ ìœ„ì¹˜
        const eRect = endCell.getBoundingClientRect();
        // endCellì˜ ë·°í¬íŠ¸ ìœ„ì¹˜

        // ë·°í¬íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì„ íƒ ì˜ì—­ì˜ ìµœì†Œ/ìµœëŒ€ ì¢Œí‘œ
        const minLeft = Math.min(sRect.left, eRect.left);
        const minTop = Math.min(sRect.top, eRect.top);
        const maxRight = Math.max(sRect.right, eRect.right);
        const maxBottom = Math.max(sRect.bottom, eRect.bottom);

        // .wrap ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì ˆëŒ€ ìœ„ì¹˜ (ìŠ¤í¬ë¡¤ì„ ê³ ë ¤í•˜ì—¬ ê³„ì‚°)
        // = (ë·°í¬íŠ¸ ìœ„ì¹˜ - wrapì˜ ë·°í¬íŠ¸ ì‹œì‘ ìœ„ì¹˜) + wrapì˜ ìŠ¤í¬ë¡¤ ìœ„ì¹˜
        const finalLeft = minLeft - wrapRect.left + wrapScrollLeft;
        const finalTop = minTop - wrapRect.top + wrapScrollTop;

        selectionBox.style.left = `${finalLeft}px`;
        selectionBox.style.top = `${finalTop}px`;
        selectionBox.style.width = `${maxRight - minLeft}px`;
        selectionBox.style.height = `${maxBottom - minTop}px`;
        selectionBox.style.display = 'block';
    };

    let lastMoveEndCell = null;

    // --- Cell Selection (Drag/Click) ë¡œì§ ---
    const handleMouseDown = (e) => {
        const clickedCell = e.target.closest('td');
        if (!clickedCell) return;

        // Ctrl(Windows/Linux) ë˜ëŠ” Meta(Cmd/Mac) í‚¤ë¥¼ ëˆŒë €ëŠ”ì§€ í™•ì¸
        const isMultiSelect = e.ctrlKey || e.metaKey;

        if (isMultiSelect) {
            // **[NEW FIX]** ë“œë˜ê·¸ ì‹œì‘ ì‹œ ëª¨ë“  í™œì„± ìš”ì†Œë¥¼ ê°•ì œë¡œ í¬ì»¤ìŠ¤ í•´ì œí•˜ì—¬ í…ìŠ¤íŠ¸ í¸ì§‘ ëª¨ë“œë¥¼ ì¢…ë£Œ
            if (document.activeElement && document.activeElement.closest('.data-table')) {
                document.activeElement.blur();
            }
            // 1. Ctrl/Cmd í‚¤ë¥¼ ëˆ„ë¥¸ ê²½ìš°: ì»¤ìŠ¤í…€ ë©€í‹° ì…€ ì„ íƒ ì‹œì‘ (ìŠ¤íƒ€ì¼ ì ìš©ìš©)
            clearSelection();
            startCell = clickedCell;
            endCell = startCell;
            // ğŸš€ [FINAL FIX] ë“œë˜ê·¸ ì¤‘ ë¸Œë¼ìš°ì € í…ìŠ¤íŠ¸ ì„ íƒì„ ì™„ì „íˆ ë§‰ê¸° ìœ„í•´ CSS í´ë˜ìŠ¤ ì ìš©
            table.classList.add('disable-select');
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            e.preventDefault(); // ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ ë™ì‘ (í…ìŠ¤íŠ¸ ì„ íƒ) ë°©ì§€
            e.stopPropagation();
        } else if (clickedCell.contentEditable === 'true') {
            // 2. ì¼ë°˜ í´ë¦­ + í¸ì§‘ ê°€ëŠ¥ ì…€: ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ í…ìŠ¤íŠ¸ í¸ì§‘ ê¸°ëŠ¥ì„ í—ˆìš©
            clearSelection();
            // ë‹¨ì¼ ì…€ì„ ì„ íƒ ìƒíƒœë¡œ ë‚¨ê²¨ë‘ì–´ ì„¤ì • íŒ¨ë„ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡
            clickedCell.classList.add('selected');
            selectedCells.add(clickedCell);
        } else {
            // 3. ì¼ë°˜ í´ë¦­ + í¸ì§‘ ë¶ˆê°€ëŠ¥ ì…€ (í—¤ë” ë“±): ë‹¨ì¼ ì…€ ì„ íƒë§Œ ì ìš©
            clearSelection();
            clickedCell.classList.add('selected');
            selectedCells.add(clickedCell);
        }
    };

    const handleMouseMove = (e) => {
        if (!startCell) return;
        // Ctrl/Cmd í‚¤ê°€ í•´ì œë˜ë©´ ë“œë˜ê·¸ ì¤‘ì§€ (ì¤‘ìš”!)
        if (!e.ctrlKey && !e.metaKey) {
            handleMouseUp();
            return;
        }

        const currentCell = e.target.closest('td');
        if (!currentCell || currentCell === lastMoveEndCell) return;

        endCell = currentCell;
        lastMoveEndCell = currentCell;

        if (startCell && endCell) {
            const startPos = getCellCoordinates(startCell);
            const endPos = getCellCoordinates(endCell);
            updateSelection(startPos, endPos);
            updateSelectionBoxVisual(startCell, endCell);
            isDragging = true;
        }
    };

    const handleMouseUp = () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        // ğŸš€ [FINAL FIX] ë“œë˜ê·¸ ì™„ë£Œ í›„ CSS í´ë˜ìŠ¤ ì œê±°
        table.classList.remove('disable-select');
        selectionBox.style.display = 'none';

        if (isDragging) {
            // ë“œë˜ê·¸ê°€ ì™„ë£Œë˜ì—ˆì„ ë•Œ, isDragging ìƒíƒœ ì´ˆê¸°í™”
            isDragging = false;
        }
        lastMoveEndCell = null;
    };

    // Table event listeners (Delegation)
    table.addEventListener('mousedown', handleMouseDown);

    /* -------------------------- Control handlers -------------------------- */

    // Color Palette setup
    const initializeColorPalette = () => {
        COLOR_PALETTE.forEach(col => {
            const d = document.createElement('div');
            d.className = 'color-swatch';
            d.style.backgroundColor = col;
            d.dataset.color = col;
            d.addEventListener('click', handleColorClick);
            colorPaletteContainer?.appendChild(d);
        });
    };

    // Color application handler
    const handleColorClick = (e) => {
        if (selectedCells.size === 0) {
            alert('ìƒ‰ìƒì„ ì ìš©í•  ì…€ì„ **Ctrl/Cmd í‚¤**ë¥¼ ëˆ„ë¥¸ ì±„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }
        
        const color = e.target.dataset.color;
        const targetType = document.querySelector('input[name="colorTarget"]:checked').value;

        selectedCells.forEach(cell => {
            if (targetType === 'text') {
                cell.style.color = color;
                cell.style.backgroundColor = ''; // ë°°ê²½ìƒ‰ ì´ˆê¸°í™” ë°©ì§€ (ëª…ì‹œì )
            } else {
                cell.style.backgroundColor = color;
                cell.style.color = ''; // ê¸€ììƒ‰ ì´ˆê¸°í™” ë°©ì§€ (ëª…ì‹œì )
            }
        });
        
        if (autoSave) saveTableStateDebounced();
    };


    // Font size apply event
    applyFontSizeBtn?.addEventListener('click', () => {
        if (selectedCells.size === 0) {
            alert('ê¸€ê¼´ í¬ê¸°ë¥¼ ì ìš©í•  ì…€ì„ **Ctrl/Cmd í‚¤**ë¥¼ ëˆ„ë¥¸ ì±„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const size = fontSizeInput.value;
        selectedCells.forEach(cell => {
            cell.style.fontSize = `${size}px`;
        });
        
        if (autoSave) saveTableStateDebounced();
    });

    // ğŸš€ [NEW] Custom Text Change Handler
    applyTextChangesBtn?.addEventListener('click', () => {
        if (topNoticeText && editTopText) {
            topNoticeText.textContent = editTopText.value;
        }
        if (bottomNoticeText && editBottomText) {
            // Textarea value (with line breaks) will be applied as innerHTML to preserve <br> tags
            bottomNoticeText.innerHTML = editBottomText.value.replace(/\n/g, '<br>');
        }
        alert('ë¬¸êµ¬ ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        if (autoSave) saveTableStateDebounced();
    });


    // Row height apply event
    document.querySelectorAll('.height-apply-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.dataset.target;
            let inputId = `${target.replace('-data', 'RowHeightInput')}`;
            if (target === 'top-notice') inputId = 'topNoticeRowHeightInput';
            if (target === 'middle-notice') inputId = 'middleNoticeRowHeightInput';
            const input = document.getElementById(inputId);
            if (input) applyRowHeight(target, input.value);
        });
    });

    // Autosave toggle
    autoSaveToggleBtn?.addEventListener('click', () => {
        autoSave = !autoSave;
        autoSaveToggleBtn.textContent = `ìë™ì €ì¥: ${autoSave ? 'ON' : 'OFF'}`;
        if (autoSave) saveTableStateDebounced();
    });

    // Manual save
    saveNowBtn?.addEventListener('click', () => saveTableStateImmediate());

    // Copy / Paste (JSON clipboard)
    copyBtn?.addEventListener('click', async () => {
        const data = [];
        // ìµœì†Œ í•˜ë‚˜ì˜ ì…€ì„ ì„ íƒí•œ ê²½ìš°ì—ë§Œ ë³µì‚¬ ì§„í–‰
        if (selectedCells.size === 0) {
            alert('ë³µì‚¬í•  ì…€ì„ Ctrl/Cmd í‚¤ë¥¼ ëˆ„ë¥¸ ì±„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const sortedCells = Array.from(selectedCells).sort((a, b) => {
            const coordA = getCellCoordinates(a);
            const coordB = getCellCoordinates(b);
            if (coordA.rowIndex !== coordB.rowIndex) return coordA.rowIndex - coordB.rowIndex;
            return coordA.cellIndex - coordB.cellIndex;
        });

        const startCoords = getCellCoordinates(sortedCells[0]);

        sortedCells.forEach(cell => {
            const coords = getCellCoordinates(cell);
            data.push({
                r: coords.rowIndex - startCoords.rowIndex, // ìƒëŒ€ì  í–‰ ìœ„ì¹˜
                c: coords.cellIndex - startCoords.cellIndex, // ìƒëŒ€ì  ì—´ 
                // ìœ„ì¹˜
                html: cell.innerHTML,
                color: cell.style.color || '',
                bg: cell.style.backgroundColor || '',
                fontSize: cell.style.fontSize || '',
            });
        });

        try {
            await navigator.clipboard.writeText(JSON.stringify({
                type: 'table_clip',
                data: data,
                baseRow: startCoords.rowIndex,
                baseCol: startCoords.cellIndex
            }));
            alert(`ì´ ${selectedCells.size}ê°œ ì…€ ë³µì‚¬ ì™„ë£Œ`);
        } catch (e) {
            console.error(e);
            alert('í´ë¦½ë³´ë“œ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });

    pasteBtn?.addEventListener('click', async () => {
        if (!adminMode) {
            alert('ê´€ë¦¬ì ëª¨ë“œ(í¸ì§‘ ê°€ëŠ¥)ì—ì„œë§Œ ë¶™ì—¬ë„£ê¸°ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }
        
        try {
            const text = await navigator.clipboard.readText();
            const clipboard = JSON.parse(text);

            if (clipboard.type !== 'table_clip' || !Array.isArray(clipboard.data)) {
                throw new Error('í´ë¦½ë³´ë“œ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }

            // ë¶™ì—¬ë„£ê¸° ì‹œì‘ì : í˜„ì¬ ì„ íƒëœ ì…€ (ë‹¨ì¼) ë˜ëŠ” ì²« ë²ˆì§¸ ì…€
            const targetCell = selectedCells.size === 1 ? Array.from(selectedCells)[0] : table.rows[0].cells[0];
            const startCoords = getCellCoordinates(targetCell);

            let appliedCount = 0;
            clipboard.data.forEach(clipCell => {
                const targetRowIndex = startCoords.rowIndex + clipCell.r;
                const targetColIndex = startCoords.cellIndex + clipCell.c;

                const row = table.rows[targetRowIndex];
                if (!row) return;

                const cell = row.cells[targetColIndex];

                // ğŸš€ FIX: ë¶™ì—¬ë„£ê¸° í—ˆìš© (Admin Modeì—ì„œ ì´ë¯¸ ëª¨ë“  ì…€ì´ trueì´ë¯€ë¡œ ë³„ë„ ì²´í¬ ë¶ˆí•„ìš”)
                if (!cell) return;
                
                cell.innerHTML = clipCell.html;
                cell.style.color = clipCell.color;
                cell.style.backgroundColor = clipCell.bg;
                cell.style.fontSize = clipCell.fontSize;

                appliedCount++;
            });

            alert(`ì´ ${appliedCount}ê°œ ì…€ ë¶™ì—¬ë„£ê¸° ì™„ë£Œ`);
            if (autoSave) saveTableStateDebounced();

        } catch (e) {
            console.error(e);
            alert('í´ë¦½ë³´ë“œ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ë¶™ì—¬ë„£ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });

    // Add row
    addRowBtn?.addEventListener('click', () => {
        if (!adminMode) {
            alert('ê´€ë¦¬ì ëª¨ë“œ(í¸ì§‘ ê°€ëŠ¥)ì—ì„œë§Œ í–‰ ì¶”ê°€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        const lastRowIndex = table.rows.length - 1; // ë§ˆì§€ë§‰ í–‰ì´ ë°ì´í„° í–‰ì´ ì•„ë‹ˆë©´, ë§ˆì§€ë§‰ ë°ì´í„° í–‰ì„ ì°¾ìŒ
        let insertBeforeIndex = table.rows.length;

        // **ë³€ê²½ëœ í…Œì´ë¸” êµ¬ì¡° ë°˜ì˜:** ì´ì œ ë°ì´í„° í–‰ë§Œ ë‚¨ì•„ìˆìœ¼ë¯€ë¡œ, ë§ˆì§€ë§‰ í–‰ ë‹¤ìŒì— ì¶”ê°€í•©ë‹ˆë‹¤.
        // ê¸°ì¡´ ì½”ë“œë¥¼ ìœ ì§€í•˜ê³  ì‹¶ë‹¤ë©´, `isDataRow`ê°€ `top-data-row`ë§Œ ì²˜ë¦¬í•˜ë„ë¡ ìœ ì§€í•©ë‹ˆë‹¤.
        if (table.rows.length > 0) {
             // í…Œì´ë¸”ì˜ ë§ˆì§€ë§‰ í–‰ ë‹¤ìŒì— ì‚½ì…
             insertBeforeIndex = table.rows.length;
        } else {
             // í…Œì´ë¸”ì´ ë¹„ì–´ìˆë‹¤ë©´, 0ë²ˆì§¸ ì¸ë±ìŠ¤ì— ì‚½ì… (ì‹¤ì œë¡œëŠ” ë¶ˆê°€ëŠ¥)
             insertBeforeIndex = 0;
        }
        
        // ì»¬ëŸ¼ ê°œìˆ˜ ê²°ì • (Header Rowì˜ ì»¬ëŸ¼ ê°œìˆ˜ë¥¼ ë”°ë¦„)
        const cols = table.querySelector('.top-data-header')?.cells.length || table.rows[0]?.cells.length || 5;

        const tr = table.insertRow(insertBeforeIndex);
        tr.className = 'top-data-row'; // ì´ì œë¶€í„° ì¶”ê°€ë˜ëŠ” í–‰ì€ 'top-data-row' ê·¸ë£¹ìœ¼ë¡œ í†µì¼
        
        // ì´ˆê¸° ë†’ì´ ì ìš© - 'top-data' ë†’ì´ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
        const heightValue = document.getElementById('topRowHeightInput').value;
        if(heightValue) applyRowHeight('top-data', heightValue); 

        for (let i = 0; i < cols; i++) {
            const td = tr.insertCell();
            td.contentEditable = adminMode; // í˜„ì¬ ê´€ë¦¬ì ëª¨ë“œ ìƒíƒœ ë°˜ì˜
            td.innerHTML = '';
        }
        
        if (autoSave) saveTableStateDebounced();
    });

    // Add column(s)
    addColBtn?.addEventListener('click', () => {
        if (!adminMode) {
            alert('ê´€ë¦¬ì ëª¨ë“œ(í¸ì§‘ ê°€ëŠ¥)ì—ì„œë§Œ ì—´ ì¶”ê°€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        if (!confirm('í…Œì´ë¸”ì˜ ëª¨ë“  í–‰ì— ìƒˆë¡œìš´ ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (colspan/rowspanì´ ìˆëŠ” í–‰ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)')) return;

        const rows = table.rows;
        if (rows.length === 0) return;

        // ë§ˆì§€ë§‰ ì»¬ëŸ¼ ì¸ë±ìŠ¤ (ê°€ì¥ ê¸´ í–‰ì„ ê¸°ì¤€ìœ¼ë¡œ)
        const maxColLength = Array.from(rows).reduce((max, row) => Math.max(max, row.cells.length), 0);
        const lastColIndex = maxColLength;

        for (let r = 0; r < rows.length; r++) {
            const row = rows[r];

            // ê³µì§€ í–‰ (colspanì´ ì „ì²´ì— ì ìš©ë¨)
            if (row.classList.contains('top-notice-row') || row.classList.contains('middle-notice-row')) {
                const td = row.cells[0];
                if (td) td.colSpan += 1;
                continue;
            }

            // ì¼ë°˜ ë°ì´í„°/í—¤ë” í–‰
            const td = row.insertCell(lastColIndex);
            td.contentEditable = adminMode;
            td.innerHTML = (row.classList.contains('top-data-header') || row.classList.contains('bottom-data-header')) ? 'ìƒˆ ì»¬ëŸ¼' : '';
        }

        if (autoSave) saveTableStateDebounced();
    });

    // Delete row(s)
    deleteRowBtn?.addEventListener('click', () => {
        if (!adminMode) {
            alert('ê´€ë¦¬ì ëª¨ë“œ(í¸ì§‘ ê°€ëŠ¥)ì—ì„œë§Œ í–‰ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        const rowIndexes = new Set();
        selectedCells.forEach(cell => rowIndexes.add(cell.closest('tr').rowIndex));
        clearSelection(); // ì‚­ì œ ì „ì— ì„ íƒ í•´ì œ

        // ì„ íƒëœ í–‰ì´ ì—†ëŠ” ê²½ìš°, ë§ˆì§€ë§‰ ë°ì´í„° í–‰ ì‚­ì œ í™•ì¸
        if (rowIndexes.size === 0) {
            for (let i = table.rows.length - 1; i >= 0; i--) {
                const r = table.rows[i];
                // **ë³€ê²½ëœ í…Œì´ë¸” êµ¬ì¡° ë°˜ì˜:** ì´ì œ `top-data-row`ë§Œ ë°ì´í„° í–‰ì…ë‹ˆë‹¤.
                if (r.classList.contains('top-data-row')) { 
                    if (confirm(`í…Œì´ë¸”ì˜ ë§ˆì§€ë§‰ ë°ì´í„° í–‰(ì¸ë±ìŠ¤: ${i})ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        table.deleteRow(i);
                        if (autoSave) saveTableStateDebounced();
                    }
                    return;
                }
            }
            alert('ì‚­ì œí•  ë°ì´í„° í–‰ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        if (!confirm(`ì„ íƒëœ ${rowIndexes.size}ê°œì˜ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìƒë‹¨ ê³µì§€/í—¤ë” í–‰ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`)) return;

        let deletedCount = 0;
        // sort descending and remove rows
        const sortedRows = Array.from(rowIndexes).sort((a, b) => b - a);

        for (const rIdx of sortedRows) {
            const r = table.rows[rIdx];
            // ì¤‘ìš”: í—¤ë”ë‚˜ ê³µì§€ í–‰ì€ ì‚­ì œ ë°©ì§€
            if (r.classList.contains('top-data-header') || r.classList.contains('top-notice-row')) {
                continue;
            }
            
            // ë°ì´í„° í–‰ë§Œ ì‚­ì œ
            if(r.classList.contains('top-data-row')) {
                table.deleteRow(rIdx);
                deletedCount++;
            }
        }

        alert(`ì´ ${deletedCount}ê°œì˜ ë°ì´í„° í–‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (ê³µì§€/í—¤ë” í–‰ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)`);
        clearSelection();
        if (autoSave && deletedCount > 0) saveTableStateDebounced();
    });

    // Delete column(s) - based on selection; if none selected, delete last column
    deleteColBtn?.addEventListener('click', () => {
        if (!adminMode) {
            alert('ê´€ë¦¬ì ëª¨ë“œ(í¸ì§‘ ê°€ëŠ¥)ì—ì„œë§Œ ì—´ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        const colIndexes = new Set();
        selectedCells.forEach(cell => colIndexes.add(cell.cellIndex));
        // build rows array snapshot
        const rows = Array.from(table.rows);
        if (rows.length === 0) return;

        if (colIndexes.size === 0) {
            // delete last column index (find max cell count -1)
            const lastRow = rows[0];
            const lastIndex = lastRow.cells.length - 1;
            if (lastIndex < 0) return;

            if (confirm(`í…Œì´ë¸”ì˜ ëª¨ë“  í–‰ì—ì„œ ê°€ì¥ ì˜¤ë¥¸ìª½ ì»¬ëŸ¼(ì¸ë±ìŠ¤: ${lastIndex})ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                for (let r = 0; r < rows.length; r++) { 
                    const row = rows[r];
                    // ê³µì§€ í–‰ì€ colspan ê°ì†Œ
                    if (row.classList.contains('top-notice-row') || row.classList.contains('middle-notice-row')) {
                        const td = row.cells[0];
                        if (td && td.colSpan > 1) td.colSpan -= 1;
                        continue;
                    }
                    if (row.cells.length > lastIndex) row.deleteCell(lastIndex);
                }
                if (autoSave) saveTableStateDebounced();
            }
            return;
        }

        if (!confirm(`ì„ íƒëœ ${colIndexes.size}ê°œì˜ ì»¬ëŸ¼ì„ ëª¨ë“  í–‰ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            (colspanì´ ì ìš©ëœ í–‰ì€ ì£¼ì˜)`)) return;
        
        let deletedColCount = 0;
        const sortedColIndexes = Array.from(colIndexes).sort((a, b) => b - a);
        
        for (const cIdx of sortedColIndexes) {
            let columnDeleted = false;
            for (let r = 0; r < rows.length; r++) {
                const row = rows[r];
                // ê³µì§€ í–‰ ì²˜ë¦¬
                if (row.classList.contains('top-notice-row') || row.classList.contains('middle-notice-row')) {
                    const td = row.cells[0];
                    if (td && td.colSpan > 1) td.colSpan -= 1;
                    columnDeleted = true;
                    continue;
                }
                
                // ì¼ë°˜ í–‰ ì²˜ë¦¬: í•´ë‹¹ ì¸ë±ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ì‚­ì œ
                if (cIdx < row.cells.length) {
                    row.deleteCell(cIdx);
                    columnDeleted = true;
                }
            }
            if(columnDeleted) deletedColCount++;
        }

        alert(`ì´ ${deletedColCount}ê°œì˜ ì»¬ëŸ¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        clearSelection();
        if (autoSave && deletedColCount > 0) saveTableStateDebounced();
    });

    // Toggle Admin Mode
    toggleAdminBtn?.addEventListener('click', () => toggleAdminMode());

    // Image Download (Selected Area)
    downloadBtn?.addEventListener('click', async () => {
        if (selectedCells.size === 0) {
            alert('ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•  ì…€ì„ **Ctrl/Cmd í‚¤**ë¥¼ ëˆ„ë¥¸ ì±„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const prevSelectionDisplay = selectionBox.style.display;
        selectionBox.style.display = 'none'; // ì„ íƒ ë°•ìŠ¤ ìˆ¨ê¹€
        
        // ìº¡ì²˜ ì˜ì—­ ê³„ì‚°
        const cellsArray = Array.from(selectedCells);
        if (cellsArray.length === 0) return;

        const wrapRect = wrap.getBoundingClientRect(); 
        const wrapScrollLeft = wrap.scrollLeft;
        const wrapScrollTop = wrap.scrollTop;

        let minX = Infinity, minY = Infinity;
        let maxX = -Infinity, maxY = -Infinity;

        cellsArray.forEach(cell => {
            const rect = cell.getBoundingClientRect();
            minX = Math.min(minX, rect.left);
            minY = Math.min(minY, rect.top);
            maxX = Math.max(maxX, rect.right);
            maxY = Math.max(maxY, rect.bottom);
        });

        // ìº¡ì²˜í•  ì˜ì—­ (wrap ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜)
        const captureX = minX - wrapRect.left + wrapScrollLeft;
        const captureY = minY - wrapRect.top + wrapScrollTop;
        const captureWidth = maxX - minX;
        const captureHeight = maxY - minY;

        // í…Œì´ë¸” ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ê°€ì¥ ê°€ê¹Œìš´ ë¶€ëª¨ë¥¼ ìº¡ì²˜ ëŒ€ìƒìœ¼ë¡œ ì§€ì •
        const captureTarget = table;

        try {
            // html2canvas ì˜µì…˜: ê³„ì‚°ëœ ì˜ì—­ë§Œ ìº¡ì²˜
            const canvas = await html2canvas(captureTarget, {
                scrollX: 0, // ìº¡ì²˜ ëŒ€ìƒì´ .wrap ì•ˆì— ìˆì–´ scrollì„ 0ìœ¼ë¡œ ì„¤ì •
                scrollY: 0,
                x: captureX, 
                y: captureY, 
                width: captureWidth, 
                height: captureHeight,
                scale: 2, // ê³ í•´ìƒë„ ìº¡ì²˜
                backgroundColor: '#1a1a1a', // ë°°ê²½ìƒ‰ ì§€ì •
                logging: false
            });

            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'captured_data_selection.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch(e) {
            console.error(e);
            alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì˜¤ë¥˜)');
        } finally {
            selectionBox.style.display = prevSelectionDisplay;
        }
    });

    // ğŸš€ [ìˆ˜ì •ëœ ê¸°ëŠ¥] ì „ì²´ ì˜ì—­ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ (Download Full)
    // ì˜¤ë¥¸ìª½ ì„¤ì • íŒ¨ë„ì„ ì œì™¸í•˜ê³  ì™¼ìª½ ë©”ë‰´ì™€ ë©”ì¸ ì½˜í…ì¸ ë§Œ ìº¡ì²˜
    downloadFullBtn?.addEventListener('click', async () => {
        const prevSelectionDisplay = selectionBox.style.display;
        selectionBox.style.display = 'none'; // ì„ íƒ ë°•ìŠ¤ ìˆ¨ê¹€
        
        // ----------------------------------------------------------------------------------
        // [ìˆ˜ì •] ì „ì²´ í™”ë©´ (Left Menu + Wrap Content)ì„ ìº¡ì²˜í•˜ë„ë¡ bodyë¥¼ ìº¡ì²˜ ëŒ€ìƒìœ¼ë¡œ ì§€ì •
        const captureTarget = document.body;

        try {
            const settingPanel = document.getElementById('settingPanel');
            // ìš°ì¸¡ ì„¤ì • íŒ¨ë„ì˜ ë„ˆë¹„ë§Œí¼ ìº¡ì²˜ ì˜ì—­ì„ ì œì™¸
            const settingPanelWidth = settingPanel ? settingPanel.offsetWidth : 300; 
            const targetWidth = window.innerWidth - settingPanelWidth; 

            // html2canvas ì˜µì…˜: ìŠ¤í¬ë¡¤ í¬í•¨, ë°°ê²½ìƒ‰ íˆ¬ëª… ë°©ì§€
            const canvas = await html2canvas(captureTarget, {
                scrollX: 0,
                scrollY: 0,
                scale: 2,
                backgroundColor: '#1a1a1a', // body ë°°ê²½ìƒ‰ìœ¼ë¡œ ì„¤ì •
                // ìº¡ì²˜ ì˜ì—­ì„ ì™¼ìª½ ë©”ë‰´ + ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ìœ¼ë¡œ í•œì • (ìš°ì¸¡ ì„¤ì • íŒ¨ë„ ì œì™¸)
                x: 0,
                y: 0,
                width: targetWidth,
                // bodyì˜ ì „ì²´ ìŠ¤í¬ë¡¤ ë†’ì´ë¥¼ í¬í•¨í•˜ë„ë¡ ì„¤ì • (ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ëª¨ë“  ë‚´ìš©ì„ ìº¡ì²˜)
                height: Math.max(document.body.scrollHeight, document.body.offsetHeight, 
                    document.documentElement.clientHeight, document.documentElement.scrollHeight, document.documentElement.offsetHeight)
            });

            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'full_data_report.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('ì „ì²´ ì˜ì—­ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch(e) {
            console.error(e);
            alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì˜¤ë¥˜)');
        } finally {
            selectionBox.style.display = prevSelectionDisplay;
        }
    });

    /* -------------------------- New: Global click handler to clear selection -------------------------- */
    document.addEventListener('click', (e) => {
        const target = e.target;
        // ë“œë˜ê·¸ ì¤‘ì´ ì•„ë‹ˆê³ , í…Œì´ë¸”/ì„¤ì • íŒ¨ë„/ë©”ë‰´ë¥¼ í´ë¦­í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì„ íƒ í•´ì œ
        if (!isDragging && 
            !target.closest('.data-table') &&
            !target.closest('.setting-panel') &&
            !target.closest('.left-menu')) 
        {
            clearSelection();
        }
    });

    /* -------------------------- New: Left menu & Top menu click behavior -------------------------- */
    if (leftMenu) {
        leftMenu.addEventListener('click', (e) => {
            const li = e.target.closest('.left-item');
            if (!li) return;
            leftMenu.querySelectorAll('.left-item').forEach(it => it.classList.remove('active'));
            li.classList.add('active');
            if (menuIndicator) menuIndicator.textContent = `ì„ íƒ: ${li.textContent.trim()}`;
        });
    }
    if (topSubMenu) {
        topSubMenu.addEventListener('click', (e) => {
            const it = e.target.closest('.menu');
            if (!it) return;
            topSubMenu.querySelectorAll('.menu').forEach(i => i.classList.remove('active'));
            it.classList.add('active');
        });
    }

    
</script>
</body>
</html>
